<!-- src/app/components/chat/chat.component.html -->

<div class="chat-wrap">

    <!-- Top Bar -->
    <div class="chat-topbar">
      <div class="topbar-left">
        <div class="conv-title">{{ activeTitle }}</div>
        <div class="conv-sub">Searching: Proposals Â· Case Studies Â· Whitepapers Â· Pitch Decks</div>
      </div>
      <div class="topbar-right">
        <button class="btn-upgrade">â¬† Upgrade Plan</button>
        <button class="btn-ghost">ğŸ• History</button>
        <button class="icon-btn">ğŸ”—</button>
        <button class="icon-btn">âœ‰</button>
        <button class="icon-btn">ğŸ””</button>
      </div>
    </div>
  
    <!-- Guardrail Banner -->
    @if (chat.banner(); as b) {
      <div class="guardrail-banner"
           [style.background]="b.color + '12'"
           [style.border-bottom-color]="b.color + '44'">
        <span class="banner-icon">{{ b.icon }}</span>
        <span class="banner-msg" [style.color]="b.color">{{ b.msg }}</span>
        <button class="banner-close" [style.color]="b.color" (click)="chat.clearBanner()">âœ•</button>
      </div>
    }
  
    <!-- Body: Messages + Source Panel -->
    <div class="chat-body">
  
      <!-- Messages -->
      <div class="messages-pane">
  
        @for (msg of chat.messages(); track trackMsg($index, msg)) {
  
          <!-- USER bubble -->
          @if (msg.role === 'user') {
            <div class="msg-user">
              <div class="bubble-user">{{ msg.text }}</div>
              <div class="msg-time">Just now</div>
            </div>
          }
  
          <!-- ASSISTANT bubble -->
          @if (msg.role === 'assistant') {
            <div class="msg-bot">
              <div class="bot-avatar">ğŸ§­</div>
              <div class="bot-content">
  
                <!-- Text bubble -->
                <div class="bubble-bot"
                     [class.guardrail-bdr]="msg.kind === 'guardrail_input'"
                     [class.oos-bdr]="msg.kind === 'guardrail_oos'">
  
                  @if (msg.kind === 'guardrail_input') {
                    <div class="guardrail-tag danger">ğŸš« Off-topic query blocked</div>
                  }
                  @if (msg.kind === 'guardrail_oos') {
                    <div class="guardrail-tag warning">âš ï¸ No matching content in corpus</div>
                  }
  
                  <span [innerHTML]="renderMd(msg.text)"></span>
                </div>
  
                <!-- Citations -->
                @if (msg.citations?.length) {
                  <div class="citations">
                    <div class="cit-label">Sources Used</div>
                    <div class="cit-chips">
                      @for (ci of msg.citations; track ci.title) {
                        <div class="cit-chip" (click)="chat.setSourceMsg(msg)">
                          <span>ğŸ“„</span>
                          <span class="cit-title">{{ ci.title }}</span>
                          <span class="cit-conf" [class.high]="ci.confidence >= 80"
                                [class.mid]="ci.confidence < 80">{{ ci.confidence }}%</span>
                        </div>
                      }
                    </div>
                  </div>
                }
  
                <!-- Follow-up chips -->
                @if (msg.followUps?.length) {
                  <div class="followups">
                    <span class="fu-lbl">Follow up:</span>
                    @for (fu of msg.followUps; track fu) {
                      <button class="fu-chip" (click)="chat.sendMessage(fu)">{{ fu }}</button>
                    }
                  </div>
                }
  
                <!-- Feedback row -->
                <div class="feedback-row">
                  <button class="fb-btn" [class.sel]="feedback[msg.id] === 'helpful'"
                          (click)="onFeedback(msg, 'helpful')">ğŸ‘ Helpful</button>
                  <button class="fb-btn" [class.sel]="feedback[msg.id] === 'not_helpful'"
                          (click)="onFeedback(msg, 'not_helpful')">ğŸ‘ Not helpful</button>
                  <span class="fb-sep">|</span>
                  @if (msg.citations?.length) {
                    <span class="grounded">âœ“ Corpus-grounded</span>
                  } @else if (msg.kind === 'answer') {
                    <span class="no-src">âš  No sources found</span>
                  }
                </div>
  
              </div>
            </div>
          }
  
        }
  
        <!-- Typing indicator -->
        @if (chat.typing()) {
          <div class="msg-bot">
            <div class="bot-avatar">ğŸ§­</div>
            <div class="typing-bubble">
              <span class="dot d1"></span>
              <span class="dot d2"></span>
              <span class="dot d3"></span>
              <span class="typing-lbl">Searching knowledge baseâ€¦</span>
            </div>
          </div>
        }
  
        <div #msgBottom></div>
      </div><!-- /messages-pane -->
  
      <!-- Source Panel (conditional) -->
      @if (chat.sourceMsg()) {
        <app-source-panel />
      }
  
    </div><!-- /chat-body -->
  
    <!-- Input Area -->
    <div class="input-area">
      <div class="input-box" [class.focused]="focused">
        <textarea
          [(ngModel)]="inputText"
          (keydown)="onKeydown($event)"
          (focus)="focused = true"
          (blur)="focused = false"
          rows="1"
          placeholder="Ask anything about our proposals, case studies or whitepapersâ€¦"
          class="chat-ta">
        </textarea>
        <div class="input-tools">
          <button class="tool-btn" title="Attach">ğŸ“</button>
          <button class="send-btn"
                  [class.active]="inputText.trim() && !chat.typing()"
                  (click)="onSend()">â–¶</button>
        </div>
      </div>
      <p class="input-hint">Enter to send Â· Shift+Enter for new line Â· All answers are source-cited</p>
    </div>
  
  </div>